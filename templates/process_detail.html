{% extends "base.html" %}

{% block title %}{{ process.name }} - {{ super() }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1>{{ process.name }}</h1>
        <p class="text-muted">{{ process.description }}</p>
    </div>
    <div class="col text-end">
        {% if not process.is_started %}
        <a href="{{ url_for('new_step', process_id=process.id) }}" class="btn btn-primary">
            <i class="bi bi-plus-lg"></i> Yeni Ana Adım
        </a>
        {% endif %}
        <form action="{{ url_for('start_process', process_id=process.id) }}" method="POST" class="d-inline">
            <button type="submit" class="btn btn-success" {% if process.is_started %}disabled{% endif %}>
                <i class="bi bi-play-fill"></i> Süreci Başlat
            </button>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th style="width: 10%">Sıra</th>
                        <th style="width: 45%">Adım Adı</th>
                        <th style="width: 20%">Sorumlu</th>
                        <th style="width: 15%">Durum</th>
                        <th style="width: 10%">İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    {% for step in steps %}
                    <tr class="{{ 'sub-step' if step.parent_id }}" {% if step.parent_id %}data-parent-id="{{ step.parent_id }}"{% endif %} 
                        data-step-id="{{ step.id }}" 
                        data-step-type="{{ step.type }}"
                        data-file-path="{{ step.file_path or '' }}"
                        data-completed-at="{{ step.completed_at|format_datetime if step.completed_at else '' }}"
                        data-description="{{ step.description or '' }}"
                        style="cursor: pointer;">
                        <td>
                            <div class="d-flex align-items-center">
                                {% if step.parent_id %}
                                <div class="step-indent" data-level="{{ step.get_full_order().count('.') }}"></div>
                                {% endif %}
                                <span>{{ step.get_full_order() }}</span>
                            </div>
                        </td>
                        <td>
                            <div class="step-content">
                                <div class="d-flex align-items-center">
                                    <div class="step-name-container d-flex align-items-center">
                                        <span class="step-name" data-step-id="{{ step.id }}">{{ step.name }}</span>
                                        <input type="text" class="form-control form-control-sm step-name-input d-none"
                                            value="{{ step.name }}" data-step-id="{{ step.id }}">
                                    </div>
                                    <div class="action-buttons d-flex gap-2 ms-auto">
                                        {% if not process.is_started %}
                                        <a href="{{ url_for('new_step', process_id=process.id, parent_id=step.id) }}"
                                            class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-plus-lg"></i> Alt Adım
                                        </a>
                                        {% endif %}
                                        {% if step.type in ['python_script', 'sql_script', 'mail', 'sql_procedure'] and step.type != 'main_step' %}
                                        <button type="button" class="btn btn-sm btn-outline-secondary show-variables"
                                            data-step-id="{{ step.id }}">
                                            <i class="bi bi-chevron-right me-1"></i> Değişkenler (<span class="variable-count">{{
                                            step.variables|length }}</span>)
                                        </button>
                                        <a href="{{ url_for('new_variable', step_id=step.id) }}"
                                            class="btn btn-sm btn-outline-secondary">
                                            <i class="bi bi-plus-lg"></i> Değişken
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if step.variables %}
                                <div class="d-none" id="variables-data-{{ step.id }}">
                                    {% for var in step.variables %}
                                    {% if var.var_type == 'mail_config' %}
                                    {% set config = (var.default_value or '{}')|from_json %}
                                    <div class="card mb-3 mail-variable-card" data-variable-id="{{ var.id }}">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">{{ var.name }}</h6>
                                            <div class="d-flex align-items-center">
                                                {{ render_mail_status(var, config, step) }}
                                                <button type="button" class="btn btn-sm btn-danger delete-variable" data-variable-id="{{ var.id }}">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body mail-details d-none">
                                            <div class="mb-3">
                                                <label class="form-label">Alıcılar</label>
                                                <input type="text" class="form-control" name="mail_to_{{ var.id }}"
                                                    value="{{ config.get('to', [])|join(', ') }}">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">CC</label>
                                                <input type="text" class="form-control" name="mail_cc_{{ var.id }}"
                                                    value="{{ config.get('cc', [])|join(', ') }}">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Konu</label>
                                                <input type="text" class="form-control"
                                                    name="mail_subject_{{ var.id }}"
                                                    value="{{ config.get('subject', '') }}">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">İçerik</label>
                                                <textarea class="form-control" name="mail_body_{{ var.id }}"
                                                    rows="4">{{ config.get('body', '') }}</textarea>
                                            </div>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox"
                                                    name="mail_active_{{ var.id }}" {% if config.get('active',
                                                    False) %}checked{% endif %}>
                                                <label class="form-check-label">Aktif/Pasif</label>
                                            </div>
                                        </div>
                                    </div>
                                    {% else %}
                                    <div class="card mb-3" data-variable-id="{{ var.id }}">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">{{ var.name }}</h6>
                                            <div class="d-flex align-items-center">
                                                <span class="badge bg-secondary me-2">{{ var.var_type }}</span>
                                                <button type="button" class="btn btn-sm btn-danger delete-variable" data-variable-id="{{ var.id }}">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label class="form-label">Değer</label>
                                                {% if var.var_type == 'boolean' %}
                                                <div class="form-check">
                                                    <input type="checkbox" class="form-check-input variable-value" 
                                                        name="value_{{ var.id }}"
                                                        data-variable-id="{{ var.id }}"
                                                        {% if var.default_value == 'true' %}checked{% endif %}>
                                                </div>
                                                {% else %}
                                                <input type="{{ 'number' if var.var_type == 'number' else 'text' }}" 
                                                    class="form-control variable-value" 
                                                    name="value_{{ var.id }}"
                                                    data-variable-id="{{ var.id }}"
                                                    value="{{ var.default_value }}">
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <div class="step-responsible-container">
                                <span class="step-responsible" data-step-id="{{ step.id }}">{{ step.responsible or
                                    'Sorumlu ekle...' }}</span>
                                <input type="text" class="form-control form-control-sm step-responsible-input d-none"
                                    value="{{ step.responsible }}" data-step-id="{{ step.id }}">
                            </div>
                        </td>
                        <td>
                            <div class="dropdown">
                                <button class="btn btn-sm dropdown-toggle status-button 
                                    {% if step.status == 'done' %}btn-success
                                    {% elif step.status == 'in_progress' %}btn-primary
                                    {% elif step.status == 'waiting' %}btn-warning
                                    {% else %}btn-secondary{% endif %}" type="button" data-bs-toggle="dropdown">
                                    {% if step.status == 'not_started' %}
                                    Başlamadı
                                    {% elif step.status == 'waiting' %}
                                    Beklemede
                                    {% elif step.status == 'in_progress' %}
                                    Devam Ediyor
                                    {% else %}
                                    Tamamlandı
                                    {% endif %}
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <form action="{{ url_for('update_step_status', step_id=step.id) }}"
                                            method="POST">
                                            <input type="hidden" name="status" value="not_started">
                                            <button type="submit" class="dropdown-item">Başlamadı</button>
                                        </form>
                                    </li>
                                    <li>
                                        <form action="{{ url_for('update_step_status', step_id=step.id) }}"
                                            method="POST">
                                            <input type="hidden" name="status" value="waiting">
                                            <button type="submit" class="dropdown-item">Beklemede</button>
                                        </form>
                                    </li>
                                    <li>
                                        <form action="{{ url_for('update_step_status', step_id=step.id) }}"
                                            method="POST">
                                            <input type="hidden" name="status" value="in_progress">
                                            <button type="submit" class="dropdown-item">Devam Ediyor</button>
                                        </form>
                                    </li>
                                    <li>
                                        <form action="{{ url_for('update_step_status', step_id=step.id) }}"
                                            method="POST">
                                            <input type="hidden" name="status" value="done">
                                            <button type="submit" class="dropdown-item">Tamamlandı</button>
                                        </form>
                                    </li>
                                </ul>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex gap-2">
                                {% if not process.is_started %}
                                <form action="{{ url_for('delete_step', step_id=step.id) }}" method="POST"
                                    class="d-inline delete-step-form">
                                    <button type="submit" class="btn btn-sm btn-danger">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                                {% endif %}
                                {% if process.is_started and step.type != 'main_step' %}
                                <button type="button" class="btn btn-sm btn-primary execute-step"
                                    data-step-id="{{ step.id }}">
                                    <i class="bi bi-play-fill"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Adım Detayları Modal -->
<div class="modal fade" id="stepDetailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header border-0">
                <div class="d-flex align-items-center gap-2">
                    <span id="modalStepNo" class="badge bg-primary rounded-pill"></span>
                    <h5 class="modal-title mb-0" id="modalStepName"></h5>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Durum ve Tip Bilgisi -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <span id="modalStepType" class="badge"></span>
                    <span id="modalStepStatus" class="badge"></span>
                </div>

                <!-- Ana Bilgiler -->
                <div class="step-details">
                    <!-- Açıklama -->
                    <div class="detail-item">
                        <div class="detail-header">
                            <i class="bi bi-card-text"></i>
                            <span>Açıklama</span>
                        </div>
                        <textarea id="modalStepDescriptionInput" class="detail-input" rows="3"></textarea>
                    </div>

                    <!-- Dosya Yolu -->
                    <div class="detail-item">
                        <div class="detail-header">
                            <i class="bi bi-folder2-open"></i>
                            <span>Dosya Yolu</span>
                        </div>
                        <div class="d-flex">
                            <input type="text" id="modalStepFilePathInput" class="detail-input flex-grow-1">
                            <button class="btn btn-icon" type="button" id="browseFileBtn">
                                <i class="bi bi-three-dots"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Sorumlu -->
                    <div class="detail-item">
                        <div class="detail-header">
                            <i class="bi bi-person"></i>
                            <span>Sorumlu</span>
                        </div>
                        <input type="text" id="modalStepResponsibleInput" class="detail-input">
                    </div>

                    <!-- Tamamlanma Tarihi -->
                    <div class="detail-item">
                        <div class="detail-header">
                            <i class="bi bi-calendar-check"></i>
                            <span>Tamamlanma Tarihi</span>
                        </div>
                        <div class="detail-text" id="modalStepCompletedAt">-</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-primary btn-sm" id="viewVariables">
                    <i class="bi bi-gear me-2"></i>Değişkenler
                </button>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

<!-- Sonuç Modalı -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Çalıştırma Sonucu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="resultSuccess" class="alert alert-success d-none" style="word-break: break-all;"></div>
                <div id="resultError" class="alert alert-danger d-none" style="word-break: break-all;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

<!-- Değişkenler Modalı -->
<div class="modal fade" id="variablesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Değişkenler</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('batch_update_variables') }}" method="POST" id="variablesForm">
                <div class="modal-body">
                    <input type="hidden" name="step_id" id="modalStepId">
                    <div class="variables-container p-3">
                        <!-- Değişkenler buraya yüklenecek -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Mail Modalı -->
<div class="modal fade" id="mailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Son Gelen Mailler</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="mailList" class="list-group">
                    <!-- Mailler buraya dinamik olarak eklenecek -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/mail.js') }}"></script>
<style>
    .step-indent {
        display: inline-block;
    }
    .step-indent[data-level="1"] { width: 20px; }
    .step-indent[data-level="2"] { width: 40px; }
    .step-indent[data-level="3"] { width: 60px; }
    .editable-field {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
    }

    .editable-text {
        flex-grow: 1;
        padding: 0.375rem 0;
        min-height: 24px;
    }

    .edit-btn {
        padding: 0.25rem 0.5rem;
    }

    .editable-field .form-control {
        flex-grow: 1;
    }

    /* Modal özelleştirmeleri */
    .modal-content {
        border: none;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    
    .modal-header {
        padding: 1.25rem 1.5rem;
    }
    
    .modal-body {
        padding: 0 1.5rem 1.5rem;
    }
    
    .modal-title {
        font-size: 1.25rem;
        font-weight: 500;
    }
    
    /* Form Controls */
    .form-floating > .form-control {
        border: 1px solid var(--bs-border-color);
        border-radius: 8px;
        background-color: var(--bs-body-bg);
    }
    
    .form-floating > .form-control:focus {
        border-color: var(--bs-primary);
        box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.1);
    }
    
    .form-floating > label {
        color: var(--bs-gray-600);
        padding-left: 1rem;
    }
    
    .form-floating > .form-control:focus ~ label {
        color: var(--bs-primary);
    }
    
    /* Badge stilleri */
    .badge {
        font-weight: 500;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
    }
    
    .badge.rounded-pill {
        padding: 0.5rem 1rem;
    }
    
    /* Python Script badge */
    .badge.python-script {
        background-color: #22c55e !important;
        color: white;
    }
    
    /* SQL Script badge */
    .badge.sql-script {
        background-color: #3b82f6 !important;
        color: white;
    }
    
    /* SQL Procedure badge */
    .badge.sql-procedure {
        background-color: #8b5cf6 !important;
        color: white;
    }
    
    /* Mail badge */
    .badge.mail {
        background-color: #f59e0b !important;
        color: white;
    }
    
    /* Main Step badge */
    .badge.main-step {
        background-color: #6366f1 !important;
        color: white;
    }
    
    /* Status Badge Colors */
    #modalStepStatus.badge {
        background-color: var(--bs-gray-500);
    }
    
    #modalStepStatus.badge[data-status="done"] {
        background-color: var(--bs-success);
    }
    
    #modalStepStatus.badge[data-status="in_progress"] {
        background-color: var(--bs-primary);
    }
    
    #modalStepStatus.badge[data-status="waiting"] {
        background-color: var(--bs-warning);
    }
    
    /* Dark tema için özel stiller */
    [data-bs-theme="dark"] .modal-content {
        background-color: var(--bs-dark);
        border: 1px solid var(--bs-border-color);
    }
    
    [data-bs-theme="dark"] .form-control {
        background-color: var(--bs-dark);
        border-color: var(--bs-border-color);
        color: var(--bs-body-color);
    }
    
    [data-bs-theme="dark"] .form-control:focus {
        background-color: var(--bs-dark);
        border-color: var(--bs-primary);
    }
    
    [data-bs-theme="dark"] .form-floating > label {
        color: var(--bs-gray-400);
    }
    
    [data-bs-theme="dark"] .text-muted {
        color: var(--bs-gray-500) !important;
    }

    /* File Path Input Styles */
    .info-group .form-label {
        font-size: 0.875rem;
        font-weight: 500;
    }

    .info-group .input-group {
        border-radius: 8px;
        overflow: hidden;
    }

    .info-group .form-control {
        border-radius: 6px 0 0 6px;
        border-color: var(--bs-border-color);
        padding: 0.5rem 0.75rem;
        height: auto;
    }

    .info-group .form-control:focus {
        border-color: var(--bs-primary);
        box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.1);
    }

    .info-group .btn {
        border-color: var(--bs-border-color);
        color: var(--bs-gray-600);
        padding: 0.5rem 0.75rem;
    }

    .info-group .btn:hover {
        background-color: var(--bs-gray-100);
        color: var(--bs-gray-700);
    }

    /* Dark Theme Support */
    [data-bs-theme="dark"] .info-group .form-control {
        background-color: var(--bs-dark);
        border-color: var(--bs-border-color);
        color: var(--bs-body-color);
    }

    [data-bs-theme="dark"] .info-group .btn {
        background-color: var(--bs-dark);
        border-color: var(--bs-border-color);
        color: var(--bs-gray-400);
    }

    [data-bs-theme="dark"] .info-group .btn:hover {
        background-color: var(--bs-gray-800);
        color: var(--bs-gray-200);
    }

    /* Step Details Styles */
    .step-details {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .detail-item {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .detail-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--bs-gray-600);
        font-size: 0.875rem;
        font-weight: 500;
    }

    .detail-header i {
        font-size: 1rem;
    }

    .detail-input {
        background-color: var(--bs-gray-100);
        border: 1px solid transparent;
        border-radius: 8px;
        padding: 0.625rem 0.75rem;
        font-size: 0.9375rem;
        color: var(--bs-body-color);
        transition: all 0.2s ease-in-out;
        width: 100%;
    }

    .detail-input:focus {
        background-color: var(--bs-body-bg);
        border-color: var(--bs-primary);
        box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.1);
        outline: none;
    }

    .detail-text {
        color: var(--bs-gray-600);
        font-size: 0.9375rem;
        padding: 0.625rem 0;
    }

    .btn-icon {
        padding: 0.625rem;
        border: 1px solid transparent;
        background-color: var(--bs-gray-100);
        color: var(--bs-gray-600);
        border-radius: 8px;
        margin-left: 0.5rem;
    }

    .btn-icon:hover {
        background-color: var(--bs-gray-200);
        color: var(--bs-gray-700);
    }

    /* Dark Theme Support */
    [data-bs-theme="dark"] .detail-input {
        background-color: var(--bs-gray-800);
        color: var(--bs-body-color);
    }

    [data-bs-theme="dark"] .detail-input:focus {
        background-color: var(--bs-dark);
        border-color: var(--bs-primary);
    }

    [data-bs-theme="dark"] .detail-header,
    [data-bs-theme="dark"] .detail-text {
        color: var(--bs-gray-400);
    }

    [data-bs-theme="dark"] .btn-icon {
        background-color: var(--bs-gray-800);
        color: var(--bs-gray-400);
    }

    [data-bs-theme="dark"] .btn-icon:hover {
        background-color: var(--bs-gray-700);
        color: var(--bs-gray-300);
    }

    /* Process Table Styles */
    .step-name, .step-responsible {
        cursor: default !important;
    }

    .step-content {
        pointer-events: none;
    }

    .action-buttons {
        pointer-events: auto;
    }

    /* Saving Indicator Style */
    .saving-indicator {
        position: fixed;
        top: 1rem;
        right: 1rem;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.875rem;
        color: white;
        opacity: 0;
        transform: translateY(-1rem);
        transition: all 0.3s ease-in-out;
        z-index: 1060;
    }

    .saving-indicator.show {
        opacity: 1;
        transform: translateY(0);
    }
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Modal ve event listener'ları başlat
    initializeModal();

    // Sayfa yüklendiğinde kaydedilen pozisyona scroll yap
    const savedStepId = localStorage.getItem('lastViewedStepId');
    if (savedStepId) {
        const stepRow = document.querySelector(`tr[data-step-id="${savedStepId}"]`);
        if (stepRow) {
            stepRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // Scroll pozisyonunu temizle
            localStorage.removeItem('lastViewedStepId');
        }
    }
});

function initializeModal() {
    // Debug için konsol mesajı
    console.log('Initializing modal...');

    // Modal elementini al
    const modalElement = document.getElementById('stepDetailModal');
    if (!modalElement) {
        console.error('Modal element not found!');
        return;
    }

    // Bootstrap'i kontrol et
    if (typeof bootstrap === 'undefined') {
        console.error('Bootstrap is not loaded!');
        return;
    }

    // Modal nesnesini oluştur
    const modal = new bootstrap.Modal(modalElement);

    // Tüm adım satırlarına click event listener ekle
    const rows = document.querySelectorAll('tr[data-step-id]');
    console.log('Found rows:', rows.length);

    rows.forEach(row => {
        row.addEventListener('click', function(e) {
            // Buton, form veya link tıklamalarını engelle
            if (e.target.closest('button, form, a, .action-buttons')) {
                return;
            }

            console.log('Row clicked, opening modal...');

            // Adım verilerini al
            const stepId = this.dataset.stepId;
            const stepType = this.dataset.stepType;
            const description = this.dataset.description;
            const filePath = this.dataset.filePath;
            const completedAt = this.dataset.completedAt;
            const stepNo = this.querySelector('td:first-child span')?.textContent || '';
            const stepName = this.querySelector('.step-name')?.textContent || '';
            const responsible = this.querySelector('.step-responsible')?.textContent.trim() || '';
            const status = this.querySelector('.status-button')?.textContent.trim() || '';
            
            // Statü rengini belirle
            let statusClass = 'bg-secondary';
            let statusText = status.trim().toLowerCase();
            if (statusText.includes('tamamlandı')) {
                statusClass = 'bg-success';
            } else if (statusText.includes('devam ediyor')) {
                statusClass = 'bg-primary';
            } else if (statusText.includes('beklemede')) {
                statusClass = 'bg-warning';
            }

            // Modal içeriğini güncelle
            modalElement.dataset.stepId = stepId;
            document.getElementById('modalStepNo').textContent = stepNo;
            document.getElementById('modalStepName').textContent = stepName;
            document.getElementById('modalStepDescriptionInput').value = description || '';
            document.getElementById('modalStepFilePathInput').value = filePath || '';
            document.getElementById('modalStepResponsibleInput').value = responsible;
            
            // Statü badge'ini güncelle
            const statusElement = document.getElementById('modalStepStatus');
            statusElement.textContent = status;
            statusElement.className = `badge ${statusClass}`;
            
            // Tamamlanma tarihini güncelle
            const completedAtElement = document.getElementById('modalStepCompletedAt');
            if (completedAt) {
                const date = new Date(completedAt);
                const formattedDate = date.toLocaleString('tr-TR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                completedAtElement.textContent = formattedDate;
            } else {
                completedAtElement.textContent = '-';
            }
            
            const stepTypeElement = document.getElementById('modalStepType');
            stepTypeElement.textContent = getStepTypeName(stepType);
            stepTypeElement.className = `badge ${stepType}`;

            // Değişkenler butonunu göster/gizle
            const viewVariablesBtn = document.getElementById('viewVariables');
            if (viewVariablesBtn) {
                viewVariablesBtn.style.display = stepType === 'main_step' ? 'none' : 'block';
            }

            // Modalı göster
            try {
                modal.show();
                console.log('Modal shown successfully');
            } catch (error) {
                console.error('Error showing modal:', error);
            }
        });
    });
}

function getStepTypeName(type) {
    const types = {
        'main_step': 'Ana Adım',
        'python_script': 'Python Script',
        'sql_script': 'SQL Script',
        'sql_procedure': 'SQL Prosedür',
        'mail': 'Mail'
    };
    return types[type] || type;
}

// Otomatik kaydetme için debounce fonksiyonu
function debounce(func, wait) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

// Kaydetme fonksiyonu
async function saveField(input) {
    const modal = document.getElementById('stepDetailModal');
    const stepId = modal.dataset.stepId;
    if (!stepId) {
        console.error('Step ID not found');
                            return;
                        }

    const fieldMap = {
        'modalStepDescriptionInput': 'description',
        'modalStepFilePathInput': 'file_path',
        'modalStepResponsibleInput': 'responsible'
    };

    const fieldName = fieldMap[input.id];
    if (!fieldName) return;

    try {
        showSavingIndicator('Kaydediliyor...');
        
        const response = await fetch(`/step/${stepId}/update`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                },
            body: `field=${fieldName}&value=${encodeURIComponent(input.value)}`
                            });

                            const result = await response.json();
        if (result.success) {
            // Ana sayfadaki görünümü güncelle
            const row = document.querySelector(`tr[data-step-id="${stepId}"]`);
            if (row) {
                if (fieldName === 'responsible') {
                    row.querySelector('.step-responsible').textContent = input.value || 'Sorumlu ekle...';
                }
                // Dataset'i güncelle
                if (fieldName === 'description') {
                    row.dataset.description = input.value;
                } else if (fieldName === 'file_path') {
                    row.dataset.filePath = input.value;
                }
            }
            showSavingIndicator('Kaydedildi', 'success');
        } else {
            showSavingIndicator('Kaydetme başarısız', 'error');
                            }
                        } catch (error) {
        console.error('Error saving field:', error);
        showSavingIndicator('Kaydetme hatası', 'error');
    }
}

// Kaydetme göstergesi fonksiyonu
function showSavingIndicator(message, type = 'info') {
    let indicator = document.querySelector('.saving-indicator');
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.className = 'saving-indicator';
        document.body.appendChild(indicator);
    }

    indicator.textContent = message;
    indicator.className = `saving-indicator show bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'}`;

    setTimeout(() => {
        indicator.classList.remove('show');
    }, 2000);
}

// Input değişikliklerini dinle
const debouncedSave = debounce(saveField, 500);
document.querySelectorAll('.detail-input').forEach(input => {
    input.addEventListener('input', () => debouncedSave(input));
    });

// Status form submit işleminden önce pozisyonu kaydet
document.querySelectorAll('.dropdown-menu form').forEach(form => {
    form.addEventListener('submit', function() {
        const stepRow = this.closest('tr');
        if (stepRow) {
            const stepId = stepRow.dataset.stepId;
            localStorage.setItem('lastViewedStepId', stepId);
        }
    });
    });
</script>
{% endblock %}

{% macro render_mail_status(var, config, step) %}
{% set config_json = config|tojson|safe %}
<div class="mail-status me-2 {% if var.mail_status == 'received' and config.get('active', False) %}has-reply text-success{% elif config.get('active', False) %}no-reply text-warning{% endif %}" 
    data-mail-subject="{{ config.get('subject', '') }}"
    data-variable-id="{{ var.id }}"
    data-config='{{ config_json }}'>
    {% if not config.get('active', False) %}
    <div>
        <i class="bi bi-dash-circle"></i>
        <span class="status-text">Pasif</span>
    </div>
    {% elif var.mail_status == 'received' and get_mail_replies(var.id) %}
    <div>
        <i class="bi bi-check-circle-fill"></i>
        <span class="status-text">Yanıt Alındı</span>
        {% set replies = get_mail_replies(var.id) %}
        {% if replies %}
        <div class="reply-details mt-2">
            <small class="d-block text-muted">Son yanıt:</small>
            <div class="reply-info">
                <strong>{{ replies[-1].sender }}</strong>
                <span class="mx-1">-</span>
                <span>{{ replies[-1].received_at.strftime('%Y-%m-%d %H:%M:%S') }}</span>
            </div>
        </div>
        {% endif %}
    </div>
    {% else %}
    <div>
        {% if not step.process.is_started %}
            <i class="bi bi-clock-history"></i>
            <span class="status-text">Süreç Başlatılmadı</span>
        {% elif config.get('sent_at') %}
            <i class="bi bi-hourglass"></i>
            <span class="status-text">Yanıt Bekleniyor</span>
            <div class="reply-details mt-2">
                <small class="d-block text-muted">Gönderilme:</small>
                <div class="reply-info">
                    <span>{{ config.get('sent_at')|format_datetime }}</span>
                </div>
            </div>
        {% else %}
            <i class="bi bi-envelope"></i>
            <span class="status-text">Gönderilmedi</span>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endmacro %}